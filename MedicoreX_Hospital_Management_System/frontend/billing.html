
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Billing System -MediCoreX Hospital Management System</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <header>
        <div class="container">
            <div class="logo">
                <img src="images/hospital-logo.png" alt="Hospital Logo" onerror="this.style.display='none'">
                <h1>MediCoreX Hospital</h1>
            </div>
            <nav>
                <ul>
                    <li><a href="dashboard.html">Dashboard</a></li>
                    <li><a href="patients.html">Patients</a></li>
                    <li><a href="doctors.html">Doctors</a></li>
                    <li><a href="appointments.html">Appointments</a></li>
                    <li><a href="billing.html">Billing</a></li>
                    <li><a href="reports.html">Reports</a></li>
                    <li><a href="index.html" id="logoutBtn">Logout</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="container">
        <div class="card">
            <div class="card-header">
                <h2>Billing & Invoice Management</h2>
            </div>

            <div id="alert-container"></div>

            <div class="search-box">
                <input type="text" id="searchBill" class="form-control" placeholder="Search bills by patient name or bill ID...">
                <button class="btn btn-primary" onclick="searchBills()">Search</button>
                <button class="btn btn-success" onclick="showAddBillModal()">Generate New Bill</button>
            </div>

            <div class="stats-container" style="margin-bottom: 20px;">
                <div class="stat-card">
                    <h3 id="totalRevenue">\u20b90</h3>
                    <p>Total Revenue</p>
                </div>
                <div class="stat-card" style="border-left-color: var(--success-color);">
                    <h3 id="paidBills">0</h3>
                    <p>Paid Bills</p>
                </div>
                <div class="stat-card" style="border-left-color: var(--warning-color);">
                    <h3 id="pendingBills">0</h3>
                    <p>Pending Bills</p>
                </div>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Bill ID</th>
                            <th>Patient</th>
                            <th>Date</th>
                            <th>Services</th>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billsTableBody">
                        <tr>
                            <td colspan="7">Loading bills...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <!-- Add/Edit Bill Modal -->
    <div id="billModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">Generate New Bill</h2>
                <span class="close" onclick="closeBillModal()">&times;</span>
            </div>
            <form id="billForm">
                <input type="hidden" id="billId">
                
                <div class="form-group">
                    <label for="selectPatient">Select Patient *</label>
                    <select id="selectPatient" class="form-control" required onchange="loadPatientAppointments()">
                        <option value="">Select Patient</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="selectAppointment">Select Appointment (Optional)</label>
                    <select id="selectAppointment" class="form-control" onchange="loadAppointmentDetails()">
                        <option value="">Select Appointment</option>
                    </select>
                </div>

                <div id="appointmentInfo" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 5px; margin-bottom: 20px;">
                    <p><strong>Doctor:</strong> <span id="appointmentDoctor">-</span></p>
                    <p><strong>Date:</strong> <span id="appointmentDate">-</span></p>
                    <p><strong>Consultation Fee:</strong> <span id="consultationFee">0</span></p>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 15px;">Bill Items</h3>
                    <div id="billItems">
                        <div class="bill-item stats-container" style="margin-bottom: 10px;">
                            <input type="text" class="form-control item-description" placeholder="Service description" required>
                            <input type="number" class="form-control item-amount" placeholder="Amount" required>
                            <button type="button" class="btn btn-danger" onclick="removeBillItem(this)">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-primary" onclick="addBillItem()">+ Add Item</button>
                </div>

                <div class="stats-container">
                    <div class="form-group">
                        <label for="discount">Discount</label>
                        <input type="number" id="discount" class="form-control" value="0" min="0" onchange="calculateTotal()">
                    </div>
                    <div class="form-group">
                        <label for="tax">Tax (%)</label>
                        <input type="number" id="tax" class="form-control" value="0" min="0" onchange="calculateTotal()">
                    </div>
                </div>

                <div style="background: #e7f3ff; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color);">Total Amount: <span id="totalAmount">0</span></h3>
                </div>

                <div class="form-group">
                    <label for="paymentStatus">Payment Status *</label>
                    <select id="paymentStatus" class="form-control" required>
                        <option value="pending">Pending</option>
                        <option value="paid">Paid</option>
                        <option value="partial">Partial Payment</option>
                    </select>
                </div>

                <div class="form-group" id="paymentMethodDiv" style="display: none;">
                    <label for="paymentMethod">Payment Method</label>
                    <select id="paymentMethod" class="form-control">
                        <option value="cash">Cash</option>
                        <option value="card">Credit/Debit Card</option>
                        <option value="upi">UPI</option>
                        <option value="insurance">Insurance</option>
                    </select>
                </div>

                <div class="form-group" id="notesDiv">
                    <label for="billNotes">Notes</label>
                    <textarea id="billNotes" class="form-control" rows="2"></textarea>
                </div>

                <div style="display: flex; gap: 10px;">
                    <button type="submit" class="btn btn-primary">Generate Bill</button>
                    <button type="button" class="btn btn-danger" onclick="closeBillModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Bill Details Modal -->
    <div id="viewBillModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Invoice Details</h2>
                <span class="close" onclick="closeViewBillModal()">&times;</span>
            </div>
            <div id="billDetails"></div>
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="btn btn-primary" onclick="closeViewBillModal()">Close</button>
                <button class="btn btn-success" onclick="printBill()">Print Invoice</button>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2024 MediCoreX Hospital Management System. All rights reserved.</p>
    </footer>

    <script src="js/main.js"></script>
    <script>
        let bills = JSON.parse(localStorage.getItem('bills')) || [];
        let patients = JSON.parse(localStorage.getItem('patients')) || [];
        let doctors = JSON.parse(localStorage.getItem('doctors')) || [];
        let appointments = JSON.parse(localStorage.getItem('appointments')) || [];
        let currentBillView = null;

        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        if (!currentUser) {
            window.location.href = 'login.html';
        }

        document.getElementById('logoutBtn').addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('currentUser');
            window.location.href = 'login.html';
        });

        window.addEventListener('DOMContentLoaded', function() {
            loadBills();
            populatePatientDropdown();
            updateBillingStats();
        });

        function loadBills() {
            const tableBody = document.getElementById('billsTableBody');
            
            if (bills.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No bills found. Click "Generate New Bill" to create one.</td></tr>';
                return;
            }

            const sortedBills = [...bills].sort((a, b) => new Date(b.date) - new Date(a.date));

            tableBody.innerHTML = sortedBills.map(bill => {
                const patient = patients.find(p => p.id === bill.patientId);
                const statusClass = bill.status === 'paid' ? 'badge-success' : 
                                   bill.status === 'partial' ? 'badge-warning' : 'badge-danger';
                
                return `
                    <tr>
                        <td><strong>${bill.id}</strong></td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td>${new Date(bill.date).toLocaleDateString()}</td>
                        <td>${bill.items.length} items</td>
                        <td><strong>\u20b9${parseFloat(bill.totalAmount).toLocaleString()}</strong></td>
                        <td><span class="badge ${statusClass}">${bill.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewBill('${bill.id}')">View</button>
                                <button class="btn btn-success btn-sm" onclick="markAsPaid('${bill.id}')" ${bill.status === 'paid' ? 'disabled' : ''}>Mark Paid</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteBill('${bill.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function updateBillingStats() {
            const totalRevenue = bills.reduce((sum, bill) => sum + parseFloat(bill.totalAmount), 0);
            const paidCount = bills.filter(b => b.status === 'paid').length;
            const pendingCount = bills.filter(b => b.status === 'pending' || b.status === 'partial').length;

            document.getElementById('totalRevenue').textContent = '\u20b9' + totalRevenue.toLocaleString();
            document.getElementById('paidBills').textContent = paidCount;
            document.getElementById('pendingBills').textContent = pendingCount;
        }

        function populatePatientDropdown() {
            const patientSelect = document.getElementById('selectPatient');
            patientSelect.innerHTML = '<option value="">Select Patient</option>';
            patients.forEach(patient => {
                patientSelect.innerHTML += `<option value="${patient.id}">${patient.name} (ID: ${patient.id})</option>`;
            });
        }

        function loadPatientAppointments() {
            const patientId = document.getElementById('selectPatient').value;
            const appointmentSelect = document.getElementById('selectAppointment');
            appointmentSelect.innerHTML = '<option value="">Select Appointment</option>';
            
            const patientAppointments = appointments.filter(apt => 
                apt.patientId === patientId && 
                (apt.status === 'completed' || apt.status === 'confirmed')
            );

            patientAppointments.forEach(apt => {
                const doctor = doctors.find(d => d.id === apt.doctorId);
                appointmentSelect.innerHTML += `<option value="${apt.id}">${new Date(apt.date).toLocaleDateString()} - ${doctor ? doctor.name : 'Unknown'}</option>`;
            });

            document.getElementById('appointmentInfo').style.display = 'none';
        }

        function loadAppointmentDetails() {
            const appointmentId = document.getElementById('selectAppointment').value;
            if (!appointmentId) {
                document.getElementById('appointmentInfo').style.display = 'none';
                return;
            }

            const appointment = appointments.find(a => a.id === appointmentId);
            const doctor = doctors.find(d => d.id === appointment.doctorId);
            
            if (doctor) {
                document.getElementById('appointmentDoctor').textContent = doctor.name;
                document.getElementById('appointmentDate').textContent = new Date(appointment.date).toLocaleDateString();
                document.getElementById('consultationFee').textContent = doctor.consultationFee;
                document.getElementById('appointmentInfo').style.display = 'block';
                
                // Auto-add consultation fee to bill
                const firstItem = document.querySelector('.item-description');
                const firstAmount = document.querySelector('.item-amount');
                if (firstItem.value === '') {
                    firstItem.value = 'Consultation Fee';
                    firstAmount.value = doctor.consultationFee;
                    calculateTotal();
                }
            }
        }

        function addBillItem() {
            const billItems = document.getElementById('billItems');
            const newItem = document.createElement('div');
            newItem.className = 'bill-item stats-container';
            newItem.style.marginBottom = '10px';
            newItem.innerHTML = `
                <input type="text" class="form-control item-description" placeholder="Service description" required>
                <input type="number" class="form-control item-amount" placeholder="Amount" required onchange="calculateTotal()">
                <button type="button" class="btn btn-danger" onclick="removeBillItem(this)">Remove</button>
            `;
            billItems.appendChild(newItem);
        }

        function removeBillItem(button) {
            const billItems = document.getElementById('billItems');
            if (billItems.children.length > 1) {
                button.parentElement.remove();
                calculateTotal();
            }
        }

        function calculateTotal() {
            const itemAmounts = document.querySelectorAll('.item-amount');
            let subtotal = 0;
            itemAmounts.forEach(input => {
                subtotal += parseFloat(input.value) || 0;
            });

            const discount = parseFloat(document.getElementById('discount').value) || 0;
            const taxRate = parseFloat(document.getElementById('tax').value) || 0;
            const taxAmount = (subtotal - discount) * (taxRate / 100);
            const total = subtotal - discount + taxAmount;

            document.getElementById('totalAmount').textContent = total.toFixed(2);
            return total;
        }

        function showAddBillModal() {
            if (patients.length === 0) {
                showAlert('No patients found. Please add a patient first.', 'warning');
                return;
            }
            document.getElementById('modalTitle').textContent = 'Generate New Bill';
            document.getElementById('billForm').reset();
            document.getElementById('billId').value = '';
            document.getElementById('appointmentInfo').style.display = 'none';
            document.getElementById('billItems').innerHTML = `
                <div class="bill-item stats-container" style="margin-bottom: 10px;">
                    <input type="text" class="form-control item-description" placeholder="Service description" required>
                    <input type="number" class="form-control item-amount" placeholder="Amount" required onchange="calculateTotal()">
                    <button type="button" class="btn btn-danger" onclick="removeBillItem(this)">Remove</button>
                </div>
            `;
            document.getElementById('totalAmount').textContent = '0';
            document.getElementById('billModal').style.display = 'block';
        }

        document.getElementById('paymentStatus').addEventListener('change', function() {
            document.getElementById('paymentMethodDiv').style.display = 
                this.value === 'paid' || this.value === 'partial' ? 'block' : 'none';
        });

        document.getElementById('billForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const billId = document.getElementById('billId').value;
            const items = [];
            document.querySelectorAll('.bill-item').forEach(item => {
                const description = item.querySelector('.item-description').value;
                const amount = item.querySelector('.item-amount').value;
                if (description && amount) {
                    items.push({ description, amount });
                }
            });

            const billData = {
                id: billId || 'B' + Date.now(),
                patientId: document.getElementById('selectPatient').value,
                appointmentId: document.getElementById('selectAppointment').value || null,
                items: items,
                subtotal: items.reduce((sum, item) => sum + parseFloat(item.amount), 0),
                discount: parseFloat(document.getElementById('discount').value) || 0,
                tax: parseFloat(document.getElementById('tax').value) || 0,
                totalAmount: calculateTotal(),
                status: document.getElementById('paymentStatus').value,
                paymentMethod: document.getElementById('paymentStatus').value !== 'pending' ? document.getElementById('paymentMethod').value : null,
                notes: document.getElementById('billNotes').value,
                date: new Date().toISOString(),
                createdAt: billId ? bills.find(b => b.id === billId)?.createdAt : new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (billId) {
                const index = bills.findIndex(b => b.id === billId);
                bills[index] = billData;
                showAlert('Bill updated successfully!', 'success');
            } else {
                bills.push(billData);
                showAlert('Bill generated successfully!', 'success');
            }

            localStorage.setItem('bills', JSON.stringify(bills));
            closeBillModal();
            loadBills();
            updateBillingStats();
        });

        function viewBill(id) {
            const bill = bills.find(b => b.id === id);
            if (!bill) return;
            
            currentBillView = bill;
            const patient = patients.find(p => p.id === bill.patientId);
            const statusClass = bill.status === 'paid' ? 'badge-success' : 
                               bill.status === 'partial' ? 'badge-warning' : 'badge-danger';

            let itemsHtml = bill.items.map(item => `
                <tr>
                    <td>${item.description}</td>
                    <td style="text-align: right;">\u20b9${parseFloat(item.amount).toLocaleString()}</td>
                </tr>
            `).join('');

            const detailsHtml = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 5px; margin-bottom: 20px;">
                    <h3 style="color: var(--primary-color); margin-bottom: 15px;">INVOICE #${bill.id}</h3>
                    <div class="stats-container">
                        <div><strong>Date:</strong> ${new Date(bill.date).toLocaleDateString()}</div>
                        <div><strong>Status:</strong> <span class="badge ${statusClass}">${bill.status.toUpperCase()}</span></div>
                    </div>
                    <div class="stats-container">
                        <div><strong>Patient:</strong> ${patient ? patient.name : 'Unknown'}</div>
                        <div><strong>Patient ID:</strong> ${bill.patientId}</div>
                    </div>
                </div>

                <table style="margin-bottom: 20px;">
                    <thead>
                        <tr>
                            <th style="background: var(--primary-color);">Description</th>
                            <th style="background: var(--primary-color); text-align: right;">Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itemsHtml}
                    </tbody>
                    <tfoot>
                        <tr>
                            <td><strong>Subtotal:</strong></td>
                            <td style="text-align: right;">\u20b9${bill.subtotal.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td><strong>Discount:</strong></td>
                            <td style="text-align: right;">-\u20b9${bill.discount.toLocaleString()}</td>
                        </tr>
                        <tr>
                            <td><strong>Tax (${bill.tax}%):</strong></td>
                            <td style="text-align: right;">\u20b9${((bill.subtotal - bill.discount) * (bill.tax / 100)).toFixed(2)}</td>
                        </tr>
                        <tr style="background: #e7f3ff;">
                            <td><strong>TOTAL:</strong></td>
                            <td style="text-align: right; font-size: 1.2rem; color: var(--primary-color);"><strong>\u20b9${parseFloat(bill.totalAmount).toLocaleString()}</strong></td>
                        </tr>
                    </tfoot>
                </table>

                ${bill.paymentMethod ? `<p><strong>Payment Method:</strong> ${bill.paymentMethod.toUpperCase()}</p>` : ''}
                ${bill.notes ? `<p><strong>Notes:</strong> ${bill.notes}</p>` : ''}
            `;

            document.getElementById('billDetails').innerHTML = detailsHtml;
            document.getElementById('viewBillModal').style.display = 'block';
        }

        function markAsPaid(id) {
            if (confirm('Mark this bill as paid?')) {
                const bill = bills.find(b => b.id === id);
                bill.status = 'paid';
                bill.updatedAt = new Date().toISOString();
                localStorage.setItem('bills', JSON.stringify(bills));
                loadBills();
                updateBillingStats();
                showAlert('Bill marked as paid!', 'success');
            }
        }

        function deleteBill(id) {
            if (confirm('Are you sure you want to delete this bill?')) {
                bills = bills.filter(b => b.id !== id);
                localStorage.setItem('bills', JSON.stringify(bills));
                loadBills();
                updateBillingStats();
                showAlert('Bill deleted successfully!', 'success');
            }
        }

        function closeBillModal() {
            document.getElementById('billModal').style.display = 'none';
        }

        function closeViewBillModal() {
            document.getElementById('viewBillModal').style.display = 'none';
        }

        function printBill() {
            if (currentBillView) {
                alert('In a production environment, this would print the invoice #' + currentBillView.id);
            }
        }

        function searchBills() {
            const searchTerm = document.getElementById('searchBill').value.toLowerCase();
            const tableBody = document.getElementById('billsTableBody');
            const filteredBills = bills.filter(bill => {
                const patient = patients.find(p => p.id === bill.patientId);
                const patientName = patient ? patient.name.toLowerCase() : '';
                return patientName.includes(searchTerm) || bill.id.toLowerCase().includes(searchTerm);
            });

            if (filteredBills.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="7">No bills found matching your search.</td></tr>';
                return;
            }

            const sortedBills = filteredBills.sort((a, b) => new Date(b.date) - new Date(a.date));
            tableBody.innerHTML = sortedBills.map(bill => {
                const patient = patients.find(p => p.id === bill.patientId);
                const statusClass = bill.status === 'paid' ? 'badge-success' : 
                                   bill.status === 'partial' ? 'badge-warning' : 'badge-danger';
                return `
                    <tr>
                        <td><strong>${bill.id}</strong></td>
                        <td>${patient ? patient.name : 'Unknown'}</td>
                        <td>${new Date(bill.date).toLocaleDateString()}</td>
                        <td>${bill.items.length} items</td>
                        <td><strong>\u20b9${parseFloat(bill.totalAmount).toLocaleString()}</strong></td>
                        <td><span class="badge ${statusClass}">${bill.status}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button class="btn btn-primary btn-sm" onclick="viewBill('${bill.id}')">View</button>
                                <button class="btn btn-success btn-sm" onclick="markAsPaid('${bill.id}')" ${bill.status === 'paid' ? 'disabled' : ''}>Mark Paid</button>
                                <button class="btn btn-danger btn-sm" onclick="deleteBill('${bill.id}')">Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function showAlert(message, type) {
            const alertContainer = document.getElementById('alert-container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            alertContainer.appendChild(alert);
            
            setTimeout(() => {
                alert.remove();
            }, 3000);
        }

        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>
